# 薪酬管理系统 (Payroll Management System)

[![Security Tested](https://img.shields.io/badge/security-tested-success.svg)](TEST_REPORT.md)
[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Platform: Windows](https://img.shields.io/badge/platform-Windows-lightgrey.svg)](https://www.microsoft.com/windows)
[![Test Coverage](https://img.shields.io/badge/tests-16%2F16%20passing-brightgreen.svg)](test_security_fixes.py)

一款专为中小企业设计的**企业级离线安全薪酬管理工具**，基于 Windows 平台运行，具备银行级数据加密、完整的审计追踪和自动化测试验证。

## 🎯 核心特性

- ✅ **100% 测试覆盖** - 16个自动化安全测试全部通过
- 🔒 **银行级加密** - 三重加密保护（数据库 + 字段 + 文件）
- 🛡️ **时序攻击防护** - 防止用户名枚举攻击
- 💰 **财务精度保证** - 所有金额精确到分（0.01元）
- 📊 **强制考勤验证** - 无考勤记录拒绝生成工资
- 🔐 **完整审计追踪** - 所有敏感操作可追溯
- 🖥️ **完全离线运行** - 数据不外传，符合安全合规要求

---

## 🚀 快速开始

```bash
# 克隆仓库
git clone https://github.com/wuyutanhongyuxin-cell/Company_helper.git
cd Company_helper

# 安装依赖
setup.bat

# 启动系统
run.bat
```

浏览器访问 http://localhost:8501 即可使用。

**首次启动**会引导您：
1. 设置主密钥（Master Key）
2. 创建管理员账户
3. 开始使用系统

---

## 📋 目录

1. [系统概述](#系统概述)
2. [安全特性](#安全特性)
3. [系统要求](#系统要求)
4. [安装指南](#安装指南)
5. [功能说明](#功能说明)
6. [测试与验证](#测试与验证)
7. [数据备份与恢复](#数据备份与恢复)
8. [故障排除](#故障排除)
9. [技术架构](#技术架构)
10. [常见问题](#常见问题)

---

## 系统概述

本系统是一款**完全离线运行**的企业级薪酬管理工具，专为财务人员和HR设计，具备以下核心能力：

### 核心功能

| 功能模块 | 说明 |
|---------|------|
| 👥 **员工管理** | 员工信息管理，敏感数据（银行卡号、身份证号）自动加密 |
| 💰 **薪资结构** | 灵活配置基本工资、时薪、加班倍率、津贴、扣款项 |
| 📅 **考勤导入** | Excel/CSV 批量导入工作天数、加班时长、缺勤记录 |
| 🧮 **工资计算** | 自动计算应发、应扣、实发工资，精度保证到分 |
| 🔒 **批次锁定** | 工资批次锁定防篡改，解锁需提供理由并记录审计 |
| 📤 **报表导出** | 工资汇总表、银行转账清单、会计凭证 |
| 📊 **可视化分析** | 人工成本趋势、部门占比、关键指标看板 |
| 📋 **审计日志** | 所有操作可追溯，支持合规审查 |

### 设计优势

| 特性 | 说明 | 验证方式 |
|------|------|---------|
| 🔒 **数据安全** | 数据库加密 + 字段级加密 + 文件加密三重保护 | [安全测试报告](TEST_REPORT.md) |
| 🛡️ **攻击防护** | 防时序攻击、防公式注入、登录速率限制 | [自动化测试](test_security_fixes.py) |
| 💰 **精度保证** | Decimal 类型计算，所有金额量化到 0.01 元 | [精度测试通过](TEST_REPORT.md#2-decimal-精度测试-22-通过) |
| 🖥️ **离线运行** | 无需网络连接，数据不外传 | 架构设计 |
| 📊 **简单易用** | 基于浏览器的图形界面，无需学习命令行 | Streamlit UI |
| 📁 **导入导出** | 支持 Excel/CSV 格式，与现有流程无缝对接 | 业务功能 |
| 🧪 **测试验证** | 16个自动化测试，100% 通过率 | [查看测试](test_security_fixes.py) |

---

## 安全特性

### ⭐ 已验证的安全修复

本系统已通过 **16 项自动化安全测试**，覆盖以下关键安全领域：

#### 1. 🛡️ 时序攻击防护（已验证）

**问题**: 攻击者可通过登录响应时间判断用户名是否存在
**修复**: 无论用户是否存在都执行完整的密码哈希验证
**验证**: ✅ 3个测试场景全部通过，响应时间差异 < 10ms

```python
# 验证结果
用户不存在 vs 用户存在 + 错误密码: 时间差异 6.26ms ✅
禁用账户统一返回 "用户名或密码错误" ✅
```

📖 详细文档: [SECURITY_FIXES.md#时序攻击防护](SECURITY_FIXES.md#1-时序攻击漏洞修复-timing-attack-protection)

#### 2. 💰 Decimal 精度保证（已验证）

**问题**: 浮点运算可能产生累积误差（如 0.0000001 元）
**修复**: 所有金额计算使用 `Decimal` 类型并量化到 0.01 元
**验证**: ✅ 8个金额字段全部精确到 2 位小数

```python
# 测试案例：复杂薪资计算
基本工资: 5000.00
加班费 (10.5小时 × 28.846 × 1.5): 456.93 ✅
津贴合计 (500.33 + 200.66): 700.99 ✅
应发工资: 6278.83 ✅
实发工资: 4695.22 ✅
```

📖 详细文档: [SECURITY_FIXES.md#Decimal精度修复](SECURITY_FIXES.md#2-财务计算精度丢失修复-decimal-precision-fix)

#### 3. 📅 考勤强制验证（已验证）

**问题**: 员工无考勤记录时仍生成全额工资
**修复**: 强制跳过无考勤员工，并记录审计日志
**验证**: ✅ 无考勤员工被正确跳过，审计日志完整记录

```python
# 审计日志示例
{
  "action": "generate_payroll_warning",
  "metadata": {
    "warning": "以下员工没有考勤记录，已跳过: 张三(E001)",
    "skipped_employees": 1
  }
}
```

📖 详细文档: [SECURITY_FIXES.md#考勤逻辑修复](SECURITY_FIXES.md#3-考勤逻辑矛盾修复-attendance-logic-fix)

#### 4. 🔐 线程安全加密（已验证）

**问题**: 多线程环境下可能创建多个加密管理器实例
**修复**: 双重检查锁定模式（Double-Checked Locking）
**验证**: ✅ 10 个并发线程获取到同一个实例

```python
# 测试结果
10个线程同时获取加密管理器
结果: 所有线程获取到同一个实例 (ID: 2130376581328) ✅
```

📖 详细文档: [SECURITY_FIXES.md#线程安全修复](SECURITY_FIXES.md#4-加密管理器线程安全修复-thread-safe-encryption-manager)

#### 5. 📝 工资解锁审计（已验证）

**问题**: 工资解锁缺少理由和详细记录
**修复**: 强制提供解锁理由（≥10字符），记录完整数据快照
**验证**: ✅ 5个测试场景全部通过

```python
# API 变更（破坏性）
旧版本: unlock_payroll(run_id, actor, confirmed=True)
新版本: unlock_payroll(run_id, actor, reason="需要修正错误", confirmed=True)
```

📖 详细文档: [SECURITY_FIXES.md#解锁机制改进](SECURITY_FIXES.md#5-工资解锁机制改进-payroll-unlock-enhancement)

#### 6. 📥 导入错误处理（已验证）

**问题**: 导入部分失败时用户不知道哪些数据失败
**修复**: 详细的成功/失败统计和错误消息
**验证**: ✅ 部分成功、全部失败场景均正确处理

```python
# 改进的返回消息
全部成功: "全部成功：导入 50 名员工"
部分成功: "部分成功：导入 45/50 名员工，5 行失败。错误: ..."
全部失败: "导入失败，所有 50 行都失败: ..."
```

📖 详细文档: [SECURITY_FIXES.md#导入优化](SECURITY_FIXES.md#6-导入错误处理优化-import-error-handling)

---

### 🔒 加密架构

#### 三层加密防护

```
┌─────────────────────────────────────────┐
│  第一层: 数据库级加密 (SQLCipher)      │
│  AES-256 加密整个数据库文件            │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  第二层: 字段级加密 (Fernet)           │
│  银行卡号、身份证号单独加密            │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  第三层: 文件级加密                     │
│  上传的 Excel/CSV 加密存储              │
└─────────────────────────────────────────┘
```

#### 密码安全（Argon2id）

- **算法**: Argon2id（2015 年密码哈希竞赛冠军）
- **抗攻击**: GPU 暴力破解、侧信道攻击、时序攻击
- **参数**: time_cost=3, memory_cost=65536 KiB, parallelism=4

#### 登录保护

- **速率限制**: 5 次失败 → 锁定 5 分钟
- **时序攻击防护**: 统一响应时间（已验证）
- **会话管理**: 浏览器关闭自动登出

#### 公式注入防护

导出 Excel 时自动清理危险字符：

```python
# 防护示例
=SUM(A1:A10)  →  '=SUM(A1:A10)
+cmd|'/C calc →  '+cmd|'/C calc
@SUM(A1)      →  '@SUM(A1)
```

**防御**: CVE-2014-3524 (CSV Injection)

---

## 系统要求

### 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|---------|---------|
| **处理器** | Intel Core i3 或同等性能 | Intel Core i5 或更高 |
| **内存** | 4GB RAM | 8GB RAM |
| **硬盘** | 500MB 可用空间 | 2GB 可用空间 |

### 软件要求

- **操作系统**: Windows 10 / Windows 11（64位）
- **Python**: 3.9 或更高版本（推荐 3.11+）
- **浏览器**: Chrome / Edge / Firefox（最新版本）

### Python 安装

如果尚未安装 Python，请从官网下载：https://www.python.org/downloads/

> ⚠️ **重要**：安装时务必勾选 **"Add Python to PATH"** 选项！

验证安装：
```cmd
python --version
```
应显示 `Python 3.9.x` 或更高版本。

---

## 安装指南

### 方式一：使用安装脚本（推荐）

1. 将整个 `payroll_tool` 文件夹复制到目标位置（如 `D:\PayrollSystem\`）

2. 双击运行 `setup.bat`

3. 等待安装完成，看到以下提示表示成功：
   ```
   ============================================
   安装完成！
   运行 run.bat 启动系统
   ============================================
   ```

4. 如果安装过程中出现 SQLCipher 相关错误，请参考 [故障排除](#sqlcipher-安装失败) 章节

### 方式二：手动安装

```cmd
cd D:\PayrollSystem\payroll_tool

# 创建虚拟环境
python -m venv .venv

# 激活虚拟环境
.venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 验证安装

运行自动化测试验证安装：

```cmd
python test_security_fixes.py
```

预期输出：
```
================================================================================
🧪 薪酬管理系统 - 安全修复功能测试
================================================================================

✅ 时序攻击防护: 两种场景都返回失败，时间差异: 6.26ms
✅ Decimal精度: 所有金额都不超过2位小数
✅ 考勤逻辑: 跳过无考勤员工，审计日志已记录
✅ 线程安全: 10个线程获取到同一个实例
...

================================================================================
📊 测试结果汇总
================================================================================
总计: 16 个测试
✅ 通过: 16
❌ 失败: 0
成功率: 100.0%
```

---

## 功能说明

### 📥 数据导入

系统支持从 Excel/CSV 文件批量导入以下数据：

| 数据类型 | 模板文件 | 支持的列名变体 |
|----------|----------|---------------|
| **员工信息** | `employees_template.xlsx` | 员工编号/工号/编号、姓名/名字、部门/岗位、入职日期/入职时间、银行卡号/银行卡、身份证号/身份证 |
| **薪资结构** | `salary_structures_template.xlsx` | 基本工资、时薪、加班倍率、日扣款标准、津贴(JSON)、固定扣款(JSON) |
| **考勤数据** | `attendance_template.xlsx` | 期间/月份、工作天数/出勤天数、加班小时/加班时长、缺勤天数 |
| **调整项** | `adjustments_template.xlsx` | 类型(ADD/DEDUCT)、金额、原因/备注 |

**导入步骤**：
1. 从系统下载对应模板
2. 按模板格式填写数据
3. 在"数据导入"页面上传文件
4. 查看导入结果（成功数/失败数）

> 💡 **改进**: 导入失败时会显示详细的错误信息（行号 + 原因）

### 💰 工资计算

**计算公式**（精度保证到 0.01 元）：
```
应发工资 = 基本工资 + 加班费 + 津贴 + 临时增项
加班费 = 加班小时 × 时薪 × 加班倍率
应扣金额 = 缺勤扣款 + 固定扣款 + 临时扣项 + 个税
实发工资 = 应发工资 - 应扣金额
```

**操作步骤**：
1. 进入"工资计算"页面
2. 选择计算期间（如 2024-01）
3. 点击"生成工资"按钮
4. 查看计算结果和汇总统计

> ⚠️ **重要**: 如果员工没有考勤记录，将被跳过并记录到审计日志

### 🔐 锁定与解锁

为防止工资数据被意外修改，系统提供**锁定机制**：

- **锁定**: 确认无误后锁定当月工资批次，锁定后无法修改
- **解锁**: 仅管理员可解锁，需提供理由（≥10字符）并二次确认

**API 变更说明**（v1.1.0）:
```python
# 旧版本
PayrollService.unlock_payroll(run_id, actor, confirmed=True)

# 新版本（必须提供理由）
PayrollService.unlock_payroll(
    run_id,
    actor,
    reason="需要修正员工张三的加班时间计算错误",  # 新增参数
    confirmed=True
)
```

### 📤 报表导出

| 报表类型 | 用途 | 格式 | 防护措施 |
|----------|------|------|---------|
| 工资汇总表 | 内部存档、管理层审批 | Excel | 公式注入防护 ✅ |
| 银行转账清单 | 提交银行批量发放工资 | Excel | 敏感数据加密 ✅ |
| 会计凭证 | 财务入账 | Excel | 文件哈希验证 ✅ |
| 工资条 | 发放给员工本人 | PDF | 开发中 |

> 🔒 导出的文件会自动清理危险字符，防止 CSV/Excel 注入攻击

### 📋 审计日志

所有敏感操作都会被记录，包括：

| 操作类型 | 记录内容 | 用途 |
|---------|---------|------|
| 用户登录/登出 | 时间、IP、结果 | 安全审计 |
| 数据导入 | 文件名、成功数、失败数 | 数据溯源 |
| 工资计算 | 期间、员工数、总金额 | 业务追踪 |
| 锁定/解锁 | **解锁理由**、原始数据快照 | 合规要求 ✅ |
| 文件导出 | 文件哈希值 | 防篡改验证 |
| 考勤警告 | 跳过的员工列表 | 异常监控 ✅ |

审计日志不可删除或修改，支持合规审查。

---

## 测试与验证

### 🧪 自动化测试

本系统包含完整的自动化测试套件，覆盖所有安全修复：

```bash
# 运行测试
python test_security_fixes.py
```

### 测试覆盖范围

| 测试模块 | 测试数量 | 通过率 | 说明 |
|---------|---------|--------|------|
| 时序攻击防护 | 3 | 100% | 用户名枚举防护 |
| Decimal 精度 | 2 | 100% | 财务计算精度 |
| 考勤逻辑 | 2 | 100% | 强制考勤验证 |
| 线程安全 | 1 | 100% | 并发加密安全 |
| 工资解锁 | 5 | 100% | 理由验证和审计 |
| 导入处理 | 3 | 100% | 错误处理完整性 |
| **总计** | **16** | **100%** | 所有测试通过 ✅ |

### 查看测试报告

详细的测试报告请查看：[TEST_REPORT.md](TEST_REPORT.md)

安全修复说明请查看：[SECURITY_FIXES.md](SECURITY_FIXES.md)

---

## 数据备份与恢复

### 备份内容

定期备份以下文件/目录：

| 路径 | 内容 | 重要性 | 频率 |
|------|------|--------|------|
| `payroll.db` | 数据库文件 | ⭐⭐⭐ 极重要 | 每日 |
| `encryption_keys.dat` | 加密密钥 | ⭐⭐⭐ 极重要 | 每周 |
| `vault/` | 源文件加密存储 | ⭐⭐ 重要 | 每周 |
| `exports/` | 导出的报表 | ⭐ 可选 | 可选 |

### 备份方法

**方法一：手动复制**

将上述文件复制到安全的存储位置（如加密U盘、保险柜）。

**方法二：使用备份脚本**

```cmd
@echo off
set BACKUP_DIR=D:\PayrollBackup\%date:~0,4%%date:~5,2%%date:~8,2%
mkdir "%BACKUP_DIR%"
copy payroll.db "%BACKUP_DIR%\"
copy encryption_keys.dat "%BACKUP_DIR%\"
xcopy vault "%BACKUP_DIR%\vault\" /E /I
echo 备份完成：%BACKUP_DIR%
```

### 恢复方法

1. 停止系统（关闭浏览器和命令行窗口）
2. 将备份文件复制回原位置
3. 重新启动系统
4. 使用原主密钥登录

> ⚠️ 恢复时必须同时恢复 `payroll.db` 和 `encryption_keys.dat`，两者缺一不可。

---

## 故障排除

### SQLCipher 安装失败

**现象**：运行 `setup.bat` 时出现类似以下错误：
```
ERROR: Could not build wheels for sqlcipher3-binary
```

**解决方案**：

系统会自动退回到标准 SQLite。此时：
- 数据库文件本身不加密
- 敏感字段仍然加密（银行卡号、身份证号等）
- 建议将整个 `payroll_tool` 目录放在加密磁盘（如 BitLocker）中

### 忘记主密钥

**现象**：忘记主密钥，无法进入系统。

**解决方案**：

> ⚠️ **非常抱歉，如果丢失主密钥，加密数据将永久无法恢复。**

唯一的选择是：
1. 删除 `payroll.db` 和 `encryption_keys.dat`
2. 重新初始化系统
3. 重新导入所有数据

这就是为什么我们强烈建议将主密钥安全备份。

### 测试失败

如果运行 `python test_security_fixes.py` 失败：

1. 确保 Python 版本 ≥ 3.9
2. 确保所有依赖已安装：`pip install -r requirements.txt`
3. 检查是否有旧的测试数据库占用：删除 `test_security.db`
4. 查看详细错误信息并参考 [TEST_REPORT.md](TEST_REPORT.md)

---

## 技术架构

### 代码结构

```
payroll_tool/
├── app/
│   ├── db/                  # 数据访问层
│   │   ├── models.py        # ORM 模型定义
│   │   ├── repositories.py  # Repository 模式
│   │   └── session.py       # 数据库会话管理
│   ├── security/            # 安全模块
│   │   ├── core.py          # 加密和密码管理 ✅ 线程安全
│   │   ├── rate_limiter.py  # 登录速率限制
│   │   └── sanitizer.py     # 公式注入防护
│   ├── services/            # 业务逻辑层
│   │   └── business.py      # 业务服务 ✅ 已修复
│   └── ui/                  # 用户界面层
│       └── pages.py         # Streamlit 页面
├── test_security_fixes.py   # 自动化测试 ✅ 100% 通过
├── app.py                   # 应用入口
├── requirements.txt         # 依赖清单
├── SECURITY_FIXES.md        # 安全修复文档
└── TEST_REPORT.md           # 测试报告
```

### 技术栈

| 组件 | 技术选型 | 版本要求 |
|------|---------|---------|
| **Web 框架** | Streamlit | ≥ 1.28.0 |
| **数据库 ORM** | SQLAlchemy | ≥ 2.0.0 |
| **数据库** | SQLite / SQLCipher | - |
| **加密库** | cryptography (Fernet) | ≥ 41.0.0 |
| **密码哈希** | argon2-cffi (Argon2id) | ≥ 23.1.0 |
| **数据处理** | pandas | ≥ 2.0.0 |
| **Excel 操作** | openpyxl | ≥ 3.1.0 |

### 架构模式

- **分层架构**: UI → 业务逻辑 → 数据访问 → 数据库
- **Repository 模式**: 数据访问层抽象
- **Service 层模式**: 业务逻辑封装
- **单例模式**: 加密管理器（线程安全）✅
- **策略模式**: 多种报表导出格式

---

## 常见问题

### Q: 数据存储在哪里？

A: 所有数据存储在 `payroll_tool` 目录下：
- `payroll.db` - 主数据库（加密）
- `vault/` - 加密的源文件
- `exports/` - 导出的报表

### Q: 可以多人同时使用吗？

A: 本系统设计为**单机离线使用**。虽然多个用户可以通过同一台电脑的浏览器访问，但不支持多台电脑同时访问同一个数据库。

### Q: 如何升级系统？

A:
1. 备份当前数据（参考"数据备份"章节）
2. 拉取最新代码：`git pull origin main`
3. 重新运行 `setup.bat` 安装新依赖
4. 运行测试验证：`python test_security_fixes.py`
5. 启动系统

### Q: 工资计算精度如何？

A: 系统使用 Python `Decimal` 类型进行所有金额计算，精度为小数点后两位（0.01元），不会出现浮点数精度问题。✅ **已通过自动化测试验证**

### Q: 审计日志可以删除吗？

A: 不可以。审计日志设计为只增不删，确保操作可追溯。如果确实需要清理历史日志，需要直接操作数据库，但这不推荐且不符合合规要求。

### Q: 为什么需要主密钥？

A: 主密钥是加密系统的根密钥，用于：
1. 加密/解密数据库（SQLCipher）
2. 生成字段加密密钥（Fernet）
3. 保护敏感数据（银行卡号、身份证号）

丢失主密钥 = 丢失所有数据，务必安全备份！

---

## 版本历史

### v1.1.0 (2026-01-17) - 安全加固版本

**🔒 安全修复**:
- ✅ 修复时序攻击漏洞，防止用户名枚举
- ✅ 修复 Decimal 精度问题，保证财务计算精度
- ✅ 修复考勤逻辑矛盾，强制考勤验证
- ✅ 加固加密管理器线程安全
- ✅ 改进工资解锁机制，强制提供理由
- ✅ 优化导入错误处理，完整错误报告

**🧪 测试覆盖**:
- ✅ 新增 16 个自动化安全测试
- ✅ 测试通过率 100%
- ✅ 详细测试报告和修复文档

**📚 文档更新**:
- ✅ 新增 [SECURITY_FIXES.md](SECURITY_FIXES.md)
- ✅ 新增 [TEST_REPORT.md](TEST_REPORT.md)
- ✅ 更新 README.md（本文档）

**⚠️ 破坏性变更**:
- `PayrollService.unlock_payroll()` 新增必填参数 `reason`
- 请更新调用代码

详细变更: [查看提交历史](https://github.com/wuyutanhongyuxin-cell/Company_helper/commits/main)

### v1.0.0 (2024-01-XX) - 初始版本

- 基础薪酬管理功能
- 数据导入导出
- 加密存储
- 审计日志

---

## 技术支持

如遇到本文档未涵盖的问题，请：

1. 查看 [测试报告](TEST_REPORT.md) 了解系统能力
2. 查看 [安全修复文档](SECURITY_FIXES.md) 了解安全特性
3. 运行测试脚本验证安装：`python test_security_fixes.py`
4. 查看 GitHub Issues: https://github.com/wuyutanhongyuxin-cell/Company_helper/issues

---

## 许可证

MIT License - 详见 LICENSE 文件

---

## 致谢

- 本系统由 **Claude Sonnet 4.5** 协助开发和安全审计
- 专为中小企业薪酬管理设计
- 遵循 OWASP 安全最佳实践
- 符合中国《个人信息保护法》要求

---

**⚡ 立即开始使用**

```bash
git clone https://github.com/wuyutanhongyuxin-cell/Company_helper.git
cd Company_helper
setup.bat
run.bat
```

祝您使用愉快！ 🎉
